// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String?
  phone       String?
  googleId    String?  @unique // Google OAuth ID
  picture     String?  // Google profile picture URL
  authMethod  AuthMethod @default(EMAIL) // Método de autenticación usado
  isVerified  Boolean  @default(false) // Si el email ha sido verificado
  lastLoginAt DateTime? // Última vez que inició sesión
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  bookings     Booking[]
  pointsLedger PointsLedger[]
  discounts    Discount[]

  @@map("users")
}

enum AuthMethod {
  EMAIL
  GOOGLE
}

model Booking {
  id                String        @id @default(cuid())
  userId            String
  vehicleType       String        // "moto", "patinete", etc.
  vehicleId         String        // ID específico del vehículo
  startAt           DateTime
  endAt             DateTime
  totalPrice        Float
  status            BookingStatus @default(PENDING)
  verificationCode  String?       @unique // Código de 6 dígitos para verificación física
  isVerified        Boolean       @default(false) // Si ha sido verificado por el admin
  pointsAwarded     Int?          // Puntos otorgados al completar
  estimatedKm       Float?        // Kilómetros estimados del viaje
  duration          Float?        // Duración en horas
  completedAt       DateTime?     // Fecha de completado
  cancelledAt       DateTime?     // Fecha de cancelación
  notes             String?       // Notas adicionales (ej: razón de cancelación)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  pointsLedger PointsLedger[]

  @@map("bookings")
}

model PointsLedger {
  id          String   @id @default(cuid())
  userId      String
  bookingId   String?
  discountId  String?  // ID del descuento si los puntos fueron gastados en un descuento
  points      Int      // Puede ser positivo (ganados) o negativo (gastados)
  reason      String   // "rental_completion", "bonus", "redemption", etc.
  description String?
  createdAt   DateTime @default(now())

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  booking  Booking?  @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  discount Discount? @relation(fields: [discountId], references: [id], onDelete: SetNull)

  @@map("points_ledger")
}

model Discount {
  id              String        @id @default(cuid())
  userId          String
  pointsUsed      Int           // Puntos gastados para generar el descuento
  discountAmount  Float         // Cantidad del descuento en euros
  discountCode    String        @unique // Código único de 6 dígitos
  status          DiscountStatus @default(PENDING)
  validatedAt     DateTime?     // Fecha de validación
  validatedBy     String?       // ID del admin que validó
  expiresAt       DateTime      // Fecha de expiración
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  pointsLedger PointsLedger[] // Registro de puntos gastados

  @@map("discounts")
}

enum DiscountStatus {
  PENDING    // Descuento generado, esperando validación
  VALIDATED  // Descuento validado en tienda
  EXPIRED    // Descuento expirado
  CANCELLED  // Descuento cancelado
}

enum BookingStatus {
  PENDING                    // Reserva creada, esperando verificación
  VERIFIED                   // Verificada por admin, lista para usar
  COMPLETED                  // Completada y puntos otorgados
  COMPLETED_NO_VERIFICATION  // Completada sin verificación (sin puntos)
  CANCELLED                  // Cancelada
  EXPIRED                    // Expirada sin usar
}